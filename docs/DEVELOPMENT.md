# 開発ガイド

このガイドでは、Commons Groundの開発環境での動作確認、テスト、トラブルシューティングについて説明します。

## 目次

- [開発環境のセットアップ](#開発環境のセットアップ)
- [動作確認手順](#動作確認手順)
- [よくある問題と解決方法](#よくある問題と解決方法)
- [パフォーマンス確認](#パフォーマンス確認)
- [セキュリティ確認](#セキュリティ確認)

## 開発環境のセットアップ

### 前提条件

[セットアップガイド](GETTING_STARTED.md) を参照して、基本的なセットアップを完了してください。

### 開発ツール

#### Prisma Studio

データベースの内容を視覚的に確認・編集できます：

```bash
npx prisma studio
```

ブラウザで `http://localhost:5555` が開きます。

#### データベースクエリ

Prisma Studioまたはデータベースクライアントで直接クエリを実行できます。

## 動作確認手順

### Phase 1の確認

#### 1. セッション作成

1. ブラウザで `http://localhost:3000` にアクセス
2. 「新しいセッションを作成」フォームで以下を入力：
   - **タイトル**: テストセッション
   - **プロンプト**: 「2030年の都市における自動運転と歩行者空間の未来」
3. 「作成」ボタンをクリック
4. セッション詳細ページ（`/sessions/[sessionId]`）に遷移することを確認

#### 2. ストーリー生成

1. `/sessions/[sessionId]/story` にアクセス
2. 「ストーリー生成」ボタンをクリック
3. ストーリーが生成されることを確認（`sf_story_ja` と `policy_story_ja`）
4. 「承認」ボタンをクリックして `status_story_approved = true` にする

#### 3. 画像生成

1. `/sessions/[sessionId]/image` にアクセス
2. 「画像生成」ボタンをクリック
3. 画像が生成されることを確認（Gemini Image API または Imagen API）
4. 画像が表示されることを確認

#### 4. 命題生成

1. `/sessions/[sessionId]/propositions` にアクセス
2. 「命題生成」ボタンをクリック
3. 日本語命題が生成されることを確認
4. 必要に応じて編集し、「承認」ボタンをクリック

#### 5. APS処理

1. `/sessions/[sessionId]/aps` にアクセス
2. 「APS実行」ボタンをクリック
3. 英訳 → Gemma-APS分割 → 再翻訳が実行されることを確認
4. 「APS承認」ボタンをクリックして `status_aps_approved = true` にする

### Phase 2の確認

#### 1. タイル選択

1. `/sessions/[sessionId]/tiles` にアクセス
2. APS承認済みの命題がタイル形式で表示されることを確認
3. 投票に使用したい命題をチェックボックスで選択
4. 「選択した X 件を投票対象として登録」ボタンをクリック
5. 投票画面（`/sessions/[sessionId]/vote`）に遷移することを確認

#### 2. 投票

1. `/sessions/[sessionId]/vote` にアクセス
2. 投票対象の命題が表示されることを確認
3. 各命題に対して Yes / No / Pass ボタンをクリック
4. 投票が保存されることを確認（ボタンがアクティブ状態になる）
5. ページをリロードしても投票内容が保持されることを確認

### Phase 3の確認

#### 1. 結果可視化

1. `/sessions/[sessionId]/results` にアクセス
2. 投票結果が自動的に集計されることを確認
3. 各命題に対して以下が表示されることを確認：
   - 賛成率（緑の棒グラフ）
   - 反対率（赤の棒グラフ）
   - Pass率（グレーの棒グラフ）
   - 総投票数

#### 2. 複数参加者での確認

1. 別のブラウザ（またはシークレットモード）で `/sessions/[sessionId]/vote` にアクセス
2. 新しい参加者として投票を実行
3. `/sessions/[sessionId]/results` で結果が更新されることを確認

## よくある問題と解決方法

### 問題1: 画像が生成されない

**確認事項**:
- `GOOGLE_SERVICE_ACCOUNT_JSON` が正しく設定されているか
- Generative Language API が有効化されているか
- ログでエラーメッセージを確認

**解決方法**:
- 環境変数を再確認
- Google Cloud Console で API の有効化を確認
- [API設定ガイド](API_SETUP.md) を参照

### 問題2: APS処理が失敗する

**確認事項**:
- `HF_API_TOKEN` が設定されているか
- Hugging Face API のクォータを確認

**解決方法**:
- 環境変数を再設定
- フォールバック処理（文分割）が動作することを確認

### 問題3: データベース接続エラー

**確認事項**:
- `DATABASE_URL` が正しく設定されているか
- データベースの接続許可設定を確認

**解決方法**:
- 接続文字列を再確認
- データベースプロバイダーの設定を確認（Neon の場合は接続プーラーを使用）

### 問題4: 投票結果が表示されない

**確認事項**:
- 投票が正しく保存されているか（Prisma Studio で確認）
- `/api/analysis/run` が正常に実行されているか

**解決方法**:
- ログでエラーを確認
- データベースの `votes` テーブルを確認

### 問題5: タイルページに命題が表示されない

**原因**: APS が承認されていない

**解決方法**:
1. `/sessions/[SESSION_ID]/aps` に戻る
2. 「APS実行」を実行
3. 「APS承認」をクリック

または、データベースで直接更新：

```sql
UPDATE "Proposition"
SET status_aps_approved = true
WHERE "sessionId" = 'YOUR_SESSION_ID';
```

### 問題6: 投票対象登録に失敗する

**原因**: 
- 選択された命題が0件
- API エラー（OpenAI API キーが設定されていないなど）

**解決方法**:
- 少なくとも1つの命題を選択
- ブラウザの開発者ツール（F12）でエラーログを確認
- 環境変数 `OPENAI_API_KEY` が設定されているか確認

### 問題7: 投票が保存されない

**原因**: 
- データベース接続エラー
- `participantId` が正しく生成されていない

**解決方法**:
- ブラウザの開発者ツール（F12）でエラーログを確認
- `localStorage` に `participantId` が保存されているか確認
- データベース接続を確認（`/api/health` にアクセス）

## パフォーマンス確認

### API レスポンス時間

- **ストーリー生成**: 通常 5-10 秒
- **画像生成**: 通常 10-30 秒
- **APS処理**: 通常 5-15 秒

### データベースクエリ

- Prisma Studio でクエリの実行時間を確認
- 必要に応じてインデックスを追加

### 最適化のヒント

- 画像生成は非同期処理として実装されているため、長時間かかってもタイムアウトしない
- APS処理は複数の命題をまとめて処理するため、効率的
- 投票結果の集計は必要に応じてキャッシュを検討

## セキュリティ確認

### 環境変数の漏洩

- `.env` ファイルが Git にコミットされていないか確認
- サービスアカウントキーが Git にコミットされていないか確認

### API キーの保護

- フロントエンドから API キーが露出していないか確認
- すべての API 呼び出しがサーバーサイドで実行されているか確認

### データベースセキュリティ

- データベース接続文字列に適切な権限が設定されているか確認
- SQLインジェクション対策（Prisma ORMを使用しているため自動的に保護される）

## チェックリスト

### ローカル環境

- [ ] セッション作成が動作する
- [ ] ストーリー生成が動作する
- [ ] 画像生成が動作する
- [ ] 命題生成が動作する
- [ ] APS処理が動作する
- [ ] タイル選択が動作する
- [ ] 投票が動作する
- [ ] 結果可視化が動作する

### データベース

- [ ] マイグレーションが正常に実行される
- [ ] Prisma Studio でデータが確認できる
- [ ] データの整合性が保たれている

### API

- [ ] すべてのAPIエンドポイントが正常に動作する
- [ ] エラーハンドリングが適切に実装されている
- [ ] ログが適切に出力される

## 関連ドキュメント

- [セットアップガイド](GETTING_STARTED.md)
- [アーキテクチャ](ARCHITECTURE.md)
- [API設定ガイド](API_SETUP.md)
- [移行ガイド](MIGRATION_GUIDES.md)

