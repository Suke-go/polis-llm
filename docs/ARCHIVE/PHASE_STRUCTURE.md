# フェーズ構造

このアプリケーションは、以下の3つのフェーズで構成されています。

## フェーズ1: 課題を設定する

**目的**: 議論のテーマとなる課題を設定し、議論可能な命題を生成する

**ステップ**:
1. **ストーリー生成** (`/sessions/[id]/story`)
   - プロンプトからSFストーリーと政策ストーリーを生成
   - ストーリーの承認

2. **画像生成** (`/sessions/[id]/image`)
   - ストーリーから代表画像を生成

3. **日本語命題生成** (`/sessions/[id]/propositions`)
   - 政策ストーリーから議論可能な日本語命題を生成
   - 命題の編集・承認

4. **APS処理** (`/sessions/[id]/aps`)
   - 日本語命題を英訳 → Gemma-APSで分割 → 再翻訳
   - APS結果の確認・承認

**完了条件**: APSが承認される（`status_aps_approved = true`）

## フェーズ2: 議論に参加する

**目的**: 生成された命題に対して、参加者が投票を行う

**ステップ**:
1. **命題選択** (`/sessions/[id]/tiles`)
   - APS承認済みの命題をタイル形式で表示
   - 投票対象として使用する命題を選択
   - 選択した命題を投票文に整形（「〜すべきだ。」形式）

2. **投票** (`/sessions/[id]/vote`)
   - 選択された命題に対して、Yes / No / Pass で投票
   - 投票内容は匿名IDに紐づいて保存

**完了条件**: 参加者が投票を完了する（任意のタイミングで完了可能）

## フェーズ3: 議論の内容を分析する

**目的**: 収集された投票結果を分析し、可視化する

**ステップ**:
1. **結果可視化** (`/sessions/[id]/results`)
   - 各命題に対する投票結果を集計
   - 賛成率・反対率・Pass率を棒グラフで表示
   - 総投票数も表示

**完了条件**: 結果が表示される（投票があれば自動的に集計される）

## フェーズ間の移行

### フェーズ1 → フェーズ2

- **前提条件**: APSが承認されている（`status_aps_approved = true`）
- **移行方法**:
  - APSページ（`/sessions/[id]/aps`）の下部にある「フェーズ2: 議論に参加する」リンクをクリック
  - または直接 `/sessions/[id]/tiles` にアクセス

### フェーズ2 → フェーズ3

- **前提条件**: 投票対象の命題が選択されている（`statements.selected_for_voting = true`）
- **移行方法**:
  - 投票ページ（`/sessions/[id]/vote`）の「結果可視化へ」リンクをクリック
  - または直接 `/sessions/[id]/results` にアクセス

## ナビゲーション

各ページの上部に **PhaseNav** コンポーネントが表示され、3つのフェーズ間を移動できます：

- **フェーズ1: 課題を設定する** - フェーズ1の最後のページ（APS）へのリンク
- **フェーズ2: 議論に参加する** - フェーズ2の最初のページ（タイル選択）へのリンク
- **フェーズ3: 議論の内容を分析する** - フェーズ3のページ（結果可視化）へのリンク

現在のフェーズはハイライト表示され、完了したフェーズは緑色で表示されます。

## UIの構成

### フェーズ1内のナビゲーション

フェーズ1内では、**StepNav** コンポーネントで4つのステップ間を移動できます：

1. ストーリー
2. 画像
3. 日本語命題
4. APS

各ステップページには「前へ」「次へ」ボタンも表示されます。

### フェーズ2内のナビゲーション

フェーズ2内では、以下のページ間を移動できます：

- タイル選択 (`/tiles`) ↔ 投票 (`/vote`)

各ページに相互リンクが表示されます。

## データフロー

```
フェーズ1: 課題設定
  ↓
Session → Story → Proposition (status_aps_approved = true)
  ↓
フェーズ2: 議論参加
  ↓
Proposition → Statement (selected_for_voting = true)
  ↓
Participant → Vote
  ↓
フェーズ3: 分析
  ↓
AnalysisResult (results_json)
```

## チェックリスト

### フェーズ1完了の確認

- [ ] セッションが作成されている
- [ ] ストーリーが生成・承認されている
- [ ] 画像が生成されている
- [ ] 命題が生成・承認されている
- [ ] **APSが実行・承認されている** ← 最重要

### フェーズ2完了の確認

- [ ] 投票対象の命題が選択されている
- [ ] 少なくとも1人の参加者が投票している

### フェーズ3完了の確認

- [ ] 投票結果が集計されている
- [ ] 結果が可視化されている

