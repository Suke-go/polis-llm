# 動作確認ガイド

## ローカル環境での動作確認

### 1. 環境のセットアップ

```bash
# 依存関係のインストール
npm install

# 環境変数の設定
# .env ファイルを作成し、必要な環境変数を設定（docs/ENV_SETUP.md を参照）
# 最低限必要な環境変数:
# - DATABASE_URL
# - OPENAI_API_KEY
# - GOOGLE_SERVICE_ACCOUNT_JSON（または env-design-54418957a0cd.json ファイルを配置）
# - HF_API_TOKEN

# データベースマイグレーション
npx prisma migrate dev

# 開発サーバーの起動
npm run dev
```

ブラウザで `http://localhost:3000` にアクセス

### 2. フロー1の確認

#### 2-1. セッション作成

1. ブラウザで `http://localhost:3000` にアクセス
2. 「新しいセッションを作成」フォームで以下を入力：
   - **タイトル**: テストセッション
   - **プロンプト**: 「2030年の都市における自動運転と歩行者空間の未来」
3. 「作成」ボタンをクリック
4. セッション詳細ページ（`/sessions/[sessionId]`）に遷移することを確認

#### 2-2. ストーリー生成

1. `/sessions/[sessionId]/story` にアクセス
2. 「ストーリー生成」ボタンをクリック
3. ストーリーが生成されることを確認（`sf_story_ja` と `policy_story_ja`）
4. 「承認」ボタンをクリックして `status_story_approved = true` にする

#### 2-3. 画像生成

1. `/sessions/[sessionId]/image` にアクセス
2. 「画像生成」ボタンをクリック
3. 画像が生成されることを確認（Gemini Image API または Imagen API）
4. 画像が表示されることを確認

#### 2-4. 命題生成

1. `/sessions/[sessionId]/propositions` にアクセス
2. 「命題生成」ボタンをクリック
3. 日本語命題が生成されることを確認
4. 必要に応じて編集し、「承認」ボタンをクリック

#### 2-5. APS 処理

1. `/sessions/[sessionId]/aps` にアクセス
2. 「APS 実行」ボタンをクリック
3. 英訳 → Gemma-APS 分割 → 再翻訳が実行されることを確認
4. 「APS 承認」ボタンをクリックして `status_aps_approved = true` にする

### 3. フロー2の確認

#### 3-1. タイル選択

1. `/sessions/[sessionId]/tiles` にアクセス
2. APS 承認済みの命題がタイル形式で表示されることを確認
3. 投票に使用したい命題をチェックボックスで選択
4. 「選択した X 件を投票対象として登録」ボタンをクリック
5. 投票画面（`/sessions/[sessionId]/vote`）に遷移することを確認

#### 3-2. 投票

1. `/sessions/[sessionId]/vote` にアクセス
2. 投票対象の命題が表示されることを確認
3. 各命題に対して Yes / No / Pass ボタンをクリック
4. 投票が保存されることを確認（ボタンがアクティブ状態になる）
5. ページをリロードしても投票内容が保持されることを確認

### 4. フロー3の確認

#### 4-1. 結果可視化

1. `/sessions/[sessionId]/results` にアクセス
2. 投票結果が自動的に集計されることを確認
3. 各命題に対して以下が表示されることを確認：
   - 賛成率（緑の棒グラフ）
   - 反対率（赤の棒グラフ）
   - Pass率（グレーの棒グラフ）
   - 総投票数

#### 4-2. 複数参加者での確認

1. 別のブラウザ（またはシークレットモード）で `/sessions/[sessionId]/vote` にアクセス
2. 新しい参加者として投票を実行
3. `/sessions/[sessionId]/results` で結果が更新されることを確認

## Vercel デプロイ後の動作確認

### 1. デプロイの確認

1. Vercel ダッシュボードでデプロイが成功したか確認
2. 本番 URL（例: `https://your-project.vercel.app`）にアクセス
3. エラーページが表示されないことを確認

### 2. 環境変数の確認

1. Vercel ダッシュボードの「Settings」→「Environment Variables」で以下を確認：
   - `DATABASE_URL` が設定されているか
   - `OPENAI_API_KEY` が設定されているか
   - `GOOGLE_SERVICE_ACCOUNT_JSON` が設定されているか
   - `HF_API_TOKEN` が設定されているか

### 3. データベース接続の確認

1. 本番 URL でセッション作成を試行
2. エラーが発生しないことを確認
3. Vercel の「Functions」タブでログを確認

### 4. API 動作の確認

#### 4-1. ストーリー生成

1. セッションを作成
2. ストーリー生成を実行
3. ログで OpenAI API の呼び出しが成功しているか確認

#### 4-2. 画像生成

1. 画像生成を実行
2. ログで Gemini Image API または Imagen API の呼び出しが成功しているか確認
3. 画像が表示されることを確認

#### 4-3. APS 処理

1. APS 実行を実行
2. ログで Hugging Face API の呼び出しが成功しているか確認
3. 命題が分割されることを確認

### 5. エンドツーエンドテスト

1. **フロー1**: セッション作成 → ストーリー生成 → 画像生成 → 命題生成 → APS 実行
2. **フロー2**: タイル選択 → 投票
3. **フロー3**: 結果可視化

各フローが正常に動作することを確認

## よくある問題と解決方法

### 問題1: 画像が生成されない

**確認事項**:
- `GOOGLE_SERVICE_ACCOUNT_JSON` が正しく設定されているか
- Generative Language API が有効化されているか
- ログでエラーメッセージを確認

**解決方法**:
- Vercel の環境変数を再確認
- Google Cloud Console で API の有効化を確認

### 問題2: APS 処理が失敗する

**確認事項**:
- `HF_API_TOKEN` が設定されているか
- Hugging Face API のクォータを確認

**解決方法**:
- 環境変数を再設定
- フォールバック処理（文分割）が動作することを確認

### 問題3: データベース接続エラー

**確認事項**:
- `DATABASE_URL` が正しく設定されているか
- データベースの接続許可設定を確認

**解決方法**:
- 接続文字列を再確認
- データベースプロバイダーの設定を確認（Neon の場合は接続プーラーを使用）

### 問題4: 投票結果が表示されない

**確認事項**:
- 投票が正しく保存されているか（Prisma Studio で確認）
- `/api/analysis/run` が正常に実行されているか

**解決方法**:
- ログでエラーを確認
- データベースの `votes` テーブルを確認

## パフォーマンス確認

### 1. API レスポンス時間

- ストーリー生成: 通常 5-10 秒
- 画像生成: 通常 10-30 秒
- APS 処理: 通常 5-15 秒

### 2. データベースクエリ

- Prisma Studio でクエリの実行時間を確認
- 必要に応じてインデックスを追加

## セキュリティ確認

1. **環境変数の漏洩**
   - `.env` ファイルが Git にコミットされていないか確認
   - サービスアカウントキーが Git にコミットされていないか確認

2. **API キーの保護**
   - フロントエンドから API キーが露出していないか確認
   - すべての API 呼び出しがサーバーサイドで実行されているか確認

## チェックリスト

### ローカル環境

- [ ] セッション作成が動作する
- [ ] ストーリー生成が動作する
- [ ] 画像生成が動作する
- [ ] 命題生成が動作する
- [ ] APS 処理が動作する
- [ ] タイル選択が動作する
- [ ] 投票が動作する
- [ ] 結果可視化が動作する

### Vercel デプロイ

- [ ] デプロイが成功する
- [ ] 環境変数が正しく設定されている
- [ ] データベースマイグレーションが実行されている
- [ ] すべてのフローが動作する
- [ ] エラーログがない

