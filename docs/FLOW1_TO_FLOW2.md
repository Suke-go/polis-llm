# フロー1からフロー2への移行ガイド

## 前提条件

フロー2に移行するには、**フロー1を完了**させる必要があります：

✅ **必須条件**:
- セッションが作成されている
- ストーリーが生成・承認されている（`status_story_approved = true`）
- 画像が生成されている（`status_image_generated = true`）
- 命題が生成・承認されている（`status_edit_approved = true`）
- **APS が実行・承認されている（`status_aps_approved = true`）** ← **最重要**

## 移行方法

### 方法1: APS ページから直接移行（推奨）

1. **フロー1の最後のステップ（APS ページ）にアクセス**
   ```
   http://localhost:3001/sessions/[SESSION_ID]/aps
   ```

2. **APS 承認を完了**
   - 「APS 実行」ボタンをクリックして処理を実行
   - 結果を確認
   - 「APS 承認」ボタンをクリックして `status_aps_approved = true` にする

3. **フロー2へのリンクをクリック**
   - ページ下部の「次のステップ: 投票と可視化」セクションに3つのリンクがあります：
     - **「フロー2: 命題タイル選択 →」** - 命題を選択して投票対象に登録
     - **「フロー2: 投票画面 →」** - 直接投票画面へ（既に選択済みの場合）
     - **「フロー3: 結果可視化 →」** - 投票結果を確認

### 方法2: 直接URLでアクセス

フロー1が完了している場合、直接URLでアクセスできます：

```
# タイル選択ページ
http://localhost:3001/sessions/[SESSION_ID]/tiles

# 投票ページ
http://localhost:3001/sessions/[SESSION_ID]/vote

# 結果可視化ページ
http://localhost:3001/sessions/[SESSION_ID]/results
```

## フロー2の手順

### ステップ1: タイル選択（`/tiles`）

1. **APS 承認済みの命題がタイル形式で表示されます**
   - セッションのタイトルと画像が上部に表示
   - 各命題がカード形式で表示

2. **投票に使用したい命題を選択**
   - チェックボックスで複数の命題を選択
   - 最低1つは選択が必要

3. **「選択した X 件を投票対象として登録」ボタンをクリック**
   - OpenAI で投票文に整形（「〜すべきだ。」形式）
   - 自動的に投票画面（`/vote`）に遷移

### ステップ2: 投票（`/vote`）

1. **投票対象の命題が表示されます**
   - 各命題カードに **Yes** / **No** / **Pass** ボタン

2. **各命題に対して投票**
   - **Yes** (+1): 賛成
   - **No** (-1): 反対
   - **Pass** (0): パス
   - ボタンをクリックすると即座に保存されます

3. **投票状態の確認**
   - 投票済みのボタンはハイライト表示
   - ページをリロードしても投票状態が保持されます

### ステップ3: 結果可視化（`/results`）

1. **投票結果が自動的に集計されます**
   - 各命題ごとに賛成率・反対率・Pass率を計算
   - 棒グラフで可視化

2. **結果の確認**
   - 緑色の棒: 賛成率
   - 赤色の棒: 反対率
   - グレーの棒: Pass率
   - 総投票数も表示

## トラブルシューティング

### 問題1: タイルページに命題が表示されない

**原因**: APS が承認されていない

**解決方法**:
1. `/sessions/[SESSION_ID]/aps` に戻る
2. 「APS 実行」を実行
3. 「APS 承認」をクリック

または、データベースで直接更新：
```sql
UPDATE "Proposition"
SET status_aps_approved = true
WHERE "sessionId" = 'YOUR_SESSION_ID';
```

### 問題2: 投票対象登録に失敗する

**原因**: 
- 選択された命題が0件
- API エラー（OpenAI API キーが設定されていないなど）

**解決方法**:
- 少なくとも1つの命題を選択
- ブラウザの開発者ツール（F12）でエラーログを確認
- 環境変数 `OPENAI_API_KEY` が設定されているか確認

### 問題3: 投票が保存されない

**原因**: 
- データベース接続エラー
- `participantId` が正しく生成されていない

**解決方法**:
- ブラウザの開発者ツール（F12）でエラーログを確認
- `localStorage` に `participantId` が保存されているか確認
- データベース接続を確認（`/api/health` にアクセス）

## チェックリスト

フロー2に移行する前に：

- [ ] フロー1のすべてのステップが完了している
- [ ] APS が承認されている（`status_aps_approved = true`）
- [ ] セッションIDを確認している
- [ ] ブラウザで `/sessions/[SESSION_ID]/tiles` にアクセスできる

## 次のステップ

フロー2が完了したら：

- **フロー3**: `/sessions/[SESSION_ID]/results` で結果を確認
- **新しいセッション**: ホームページ（`/`）から新しいセッションを作成
- **複数参加者でのテスト**: 別ブラウザで同じ投票ページにアクセスして複数の投票を収集

