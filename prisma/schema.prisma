generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id        String   @id @default(uuid())
  title     String
  prompt    String?
  createdAt DateTime @default(now())

  stories         Story[]
  propositions    Proposition[]
  statements      Statement[]
  participants    Participant[]
  analysisResults AnalysisResult?
}

model Story {
  id                     String   @id @default(uuid())
  sessionId              String
  session                Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sf_story_ja            String   @db.Text
  policy_story_ja        String   @db.Text
  status_story_approved  Boolean  @default(false)
  image_url              String?  @db.Text
  status_image_generated Boolean  @default(false)

  @@unique([sessionId])
}

model Proposition {
  id                   String   @id @default(uuid())
  sessionId            String
  session              Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  ja_text              String   @db.Text
  en_text              String?  @db.Text
  back_translated_ja   String?  @db.Text
  translation_diff_score Float? 
  status_edit_approved Boolean  @default(false)
  status_aps_approved  Boolean  @default(false)
  statements           Statement[]
}

model Statement {
  id                 String       @id @default(uuid())
  sessionId          String
  propositionId      String
  session            Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  proposition        Proposition  @relation(fields: [propositionId], references: [id], onDelete: Cascade)
  text_ja            String       @db.Text
  text_en            String?      @db.Text
  selected_for_voting Boolean     @default(true)
  votes              Vote[]

  @@unique([sessionId, propositionId])
  @@index([sessionId])
  @@index([propositionId])
}

model Participant {
  id        String   @id @default(uuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  votes     Vote[]
}

model Vote {
  participantId String
  statementId   String
  vote          Int
  createdAt     DateTime @default(now())

  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  statement   Statement   @relation(fields: [statementId], references: [id], onDelete: Cascade)

  @@id([participantId, statementId])
}

model AnalysisResult {
  sessionId  String   @id
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  resultsJson Json    @db.JsonB
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

